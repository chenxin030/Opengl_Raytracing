# OpenGL 实时光线追踪渲染器

一个基于现代OpenGL（4.3+）构建的实时光线追踪渲染器，支持动态场景编辑和实时交互。使用计算着色器进行光线追踪计算，集成ImGui实现可视化参数控制。

# OpenGL光线追踪前向渲染管线阶段性总结

## 📦 核心功能概览
- **PBR材质** | **Bloom效果** | **PCF/PCSS阴影**  
- **SSAO环境光遮蔽** | **Skybox天空盒** | **TAA时间抗锯齿**  
- **3种光源**（点光/定向光/区域光） | **2种几何体**（球体/平面）
- **WASD + 鼠标右键控制摄像机**
- **实时帧率显示（带颜色状态指示）**
- **场景物体实时编辑（位置/颜色/尺寸）**
- **SSBO（着色器存储缓冲对象）数据传输**
- **AABB**

---

## 🛠 功能实现细节

### 1. 渲染管线流程
```plaintext
1. 光线追踪计算 → 2. SSAO环境遮蔽 → 3. Bloom高光处理 → 4. TAA抗锯齿 → 5. 最终合成
```
#### 光线追踪计算：
1. 遍历物体求交：未命中 → 采样天空盒颜色 → 结束；
2. 命中：
   1. 计算光照（包括阴影和PBR）
   2. 计算反射/折射
   3. 俄罗斯轮盘赌判断是否提前终止
   4. 选择反射或折射（选择射线方向）给下一次用
   5. 存储最终颜色、命中位置、命中位置的法线
3. 光照计算：`vec3 computeLighting(vec3 Position, vec3 Normal, Material mat, vec3 ViewDirection)`，先为计算阴影和PBR准备数据：遍历光源，根据光源类型，分别要计算的内容是：
   1. 点光源：光源到物体的方向和距离、衰减比例
   2. 定向光源：光源到物体的方向和距离(前者和光照方向一致，后者设置一个非常大的值)
   3. 区域光：光源到物体的方向和距离、衰减
4. 阴影（因子）计算：`float calculateShadow(vec3 point, vec3 normal, vec3 lightDir, float lightDistance, Light light)`
   1. PCF
   2. PCSS
5. 计算PBR：`vec3 computePBR(Material mat, vec3 N, vec3 V, vec3 L, vec3 H, vec3 radiance)`
   1. 法线分布函数（GGX/Trowbridge-Reitz）
   2. 几何遮蔽函数（Schlick-GGX）
   3. 菲涅尔方程（Schlick近似）
   4. 组合BRDF，得到镜面反射比例
   5. 计算漫反射
6. 计算光源得到的结果加到`finalColor`
---

### 2. 核心模块解析

#### 📌 **光线追踪引擎**
- **实现文件**: `raytracingCs.glsl`
- **关键技术**:
  - **光线生成**: 根据相机参数生成初始光线，支持抖动采样（Jittering）
  - **求交算法**:
    - *球体*: 解二次方程检测交点（`intersectSphere`）
    - *平面*: 使用法向量与平面方程计算交点（`intersectPlane`）
  - **加速结构**: 通过AABB包围盒进行初步剔除（`intersectAABB`）
  - **递归限制**: 最大深度`MAX_RAY_DEPTH=1`，能量衰减控制光线终止

#### 📌 **PBR材质系统**
- **实现文件**: `raytracingCs.glsl`
- **计算模型**:
  - **BRDF组成**:
    - 法线分布（GGX NDF）
    - 几何遮蔽（Schlick-GGX G）
    - 菲涅尔反射（Schlick近似）
  - **能量守恒**: 漫反射(`kD`)与镜面反射(`F`)动态分配
  - **折射处理**: 根据Snell定律计算折射方向，支持全内反射

#### 📌 **光源系统**
- **光源类型**:
  - **点光源**: 球状衰减（`1/d²`）
  - **定向光**: 无限远平行光
  - **区域光**: 圆盘采样（余弦加权+PDF计算）
- **阴影技术**:
  - **PCF**: 多采样软化阴影边缘（`pcfShadow`）
    - 通过对阴影贴图进行多次采样并平均比较结果，柔化阴影边缘。
    - 实现方式：在目标像素周围进行N×N采样，统计深度比较成功的比例作为阴影因子。
  - **PCSS**: 动态半影调节（`pcssShadow`）
    - 动态计算半影区域大小，结合PCF实现软阴影。
    - 通过模拟光源的物理尺寸动态调整阴影软硬程度，分三步实现：
      - 遮挡物深度估计：在遮挡区域采样，计算平均遮挡深度。
      - 半影尺寸计算：根据光源尺寸和遮挡关系，动态确定阴影模糊范围。
      - 动态PCF：使用计算出的半影尺寸执行PCF。

#### 📌 **Halton序列和hammersley**
低差异序列确保采样点均匀分布，减少噪声。

#### 📌 **余弦加权半球采样（重要性采样）**

#### 📌 **时空滤波降噪**
如果法线变化大就降低历史权重

#### 📌 **Bloom效果**
- **管线阶段**: 后处理阶段
- **实现流程**:
  1. **高亮提取**: 亮度阈值过滤（`brightness_extractFs.glsl`）
  2. **高斯模糊**: 双通道分离式模糊（水平+垂直，`gaussian_blurFs.glsl`）
  3. **合成叠加**: 原图与模糊图加权混合（`bloom_combineFs.glsl`）

#### 📌 **SSAO环境光遮蔽**
- **实现文件**: `ssaoFs.glsl` + `ssao_blurFs.glsl`
- **关键技术**:
  - **半球采样**: 64个随机采样点（TBN空间转换）
  - **深度测试**: 屏幕空间深度对比+范围检查
  - **后处理模糊**: 高斯模糊降噪（5x5卷积核）

#### 📌 **TAA时间抗锯齿**
- **实现文件**: `taaFs.glsl`
- **核心算法**:
  - **历史帧混合**: 使用AABB裁剪消除鬼影（`clipAABB`）
  - **抖动采样**: Halton序列生成子像素偏移
  - **动态混合因子**: 可调节的历史帧权重（`uBlendFactor`）

#### 📌 **天空盒系统**
- **实现方式**:
  - HDR环境图转立方体贴图（`ConvertHDRToCubemap`）
  - 光线未命中物体时采样天空盒（`skybox`采样器）
- **优化点**: Mipmap生成与三线性过滤

---

### 3. 性能优化
- **计算着色器**: 32x32工作组尺寸（`raytracingCs.glsl`）
- **俄罗斯轮盘赌**: 深度>3时概率终止光线
- **资源绑定**:
  - 使用SSBO存储场景物体/光源数据
  - G-Buffer分离存储位置/法线信息（`gPositionTex`/`gNormalTex`）

---

### 4. 扩展能力
- **动态加载系统**:
  - 支持实时添加/删除物体光源（`SSBO`）
  - ImGUI参数调节（阴影质量/抗锯齿强度等）
- **跨格式支持**:
  - HDR环境图（`.hdr`）
  - 多分辨率适配（动态Viewport）

--- 

### 5. RenderDoc使用经历
- 通过SSBO传数据时，查看CS的Read/Write Bindings看到数据对齐出现问题（通过alignas解决）。
- 切换skybox时，天空盒效果消失，切换回默认天空盒也是全黑，可以在CS的Textures的Slot看到我激活的纹理插槽错误。

---

### 6.项目建立过程
1. 渲染窗口
2. 添加物体：直接在计算着色器中创建物体，但不能修改也不能增删物体
3. 可以通过UI增删、修改物体
4. 添加摄像机，可以移动、移动视角、fov
5. 添加光源
6. 把Phong着色模型改为Blinn-Phong着色模型
7. 添加天空盒
8. 材质、折射
9. 阴影、区域光
10. 加载和保存场景物体和光源
11. PBR
12. bloom
13. taa
14. GPU计时
15. SSAO
16. PCF & PCSS 
17. AABB 
18. 包装前向渲染管线
19. 重要性采样、低差异序列、间接光照的漫反射采样、时空滤波